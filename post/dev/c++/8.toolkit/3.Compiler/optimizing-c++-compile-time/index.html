<!DOCTYPE html>
<html class="no-js" lang="zh-cn">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Optimizing C&#43;&#43; Compile Time - é™ˆæ˜¾æ£®çš„GitBlog</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="Optimizing C&#43;&#43; Compile Time">
		<meta property="og:title" content="Optimizing C&#43;&#43; Compile Time" />
<meta property="og:description" content="Optimizing C&#43;&#43; Compile Time" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://corsair-cxs.github.io/post/dev/c&#43;&#43;/8.toolkit/3.compiler/optimizing-c&#43;&#43;-compile-time/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-02-21T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-02-21T00:00:00+00:00" />

		<meta itemprop="name" content="Optimizing C&#43;&#43; Compile Time">
<meta itemprop="description" content="Optimizing C&#43;&#43; Compile Time"><meta itemprop="datePublished" content="2023-02-21T00:00:00+00:00" />
<meta itemprop="dateModified" content="2023-02-21T00:00:00+00:00" />
<meta itemprop="wordCount" content="2547">
<meta itemprop="keywords" content="C&#43;&#43;," />
		<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Optimizing C&#43;&#43; Compile Time"/>
<meta name="twitter:description" content="Optimizing C&#43;&#43; Compile Time"/>

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	<link rel="stylesheet" href="/css/custom.css">

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo logo--mixed">
		<a class="logo__link" href="/" title="é™ˆæ˜¾æ£®çš„åšå®¢" rel="home">
			<div class="logo__item logo__imagebox">
					<img class="logo__img" src="/img/gedu.jpg">
				</div><div class="logo__item logo__text">
					<div class="logo__title">é™ˆæ˜¾æ£®çš„åšå®¢</div>
					<div class="logo__tagline">æ­£å¿ƒè¯šæ„ï¼Œæ ¼ç‰©è‡´çŸ¥</div>
				</div>
		</a>
	</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">èœå•</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/post/">
				
				<span class="menu__text">åšå®¢æ–‡ç« </span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/categories/">
				
				<span class="menu__text">æ‰€æœ‰åˆ†ç±»</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/tags/">
				
				<span class="menu__text">æ‰€æœ‰æ ‡ç­¾</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/about">
				
				<span class="menu__text">å…³äºæˆ‘</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Optimizing C&#43;&#43; Compile Time</h1>
			<p class="post__lead">Optimizing C&#43;&#43; Compile Time</p>
			<div class="post__meta meta"><div class="meta__item-author meta__item">
	<svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2 0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class="meta__text">Corsair-cxs</span>
</div>
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class="meta__text" datetime="2023-02-21T00:00:00Z">2023-02-21</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg><span class="meta__text"><a class="meta__link" href="/categories/compile/" rel="category">Compile</a>
	</span>
</div></div>
		</header>
		<div class="content post__content clearfix">
			<h1 id="optimizing-c-compile-time">Optimizing C++ Compile Time</h1>
<blockquote>
<p>ç¼–è¯‘æ˜¯é™æ€è¯­è¨€ä¸å¯é¿å…çš„æ­¥éª¤ã€‚ å¯¹äºå¼€å‘è€…è€Œè¨€ï¼Œç¼–è¯‘æ˜¯ä¸ªåˆçˆ±åˆæ¨çš„ä¸œè¥¿ï¼Œå¥½å¤„æ˜¯ä»–å¯ä»¥å¸®åŠ©åœ¨ç¼–è¯‘æ—¶æœŸæ‰¾å‡ºéƒ¨åˆ†çš„é”™è¯¯åˆå¯ä»¥å¸®å¿™æœ€ä½³åŒ–ï¼Œä½†æ˜¯åå¤„åˆ™æ˜¯ç¼–è¯‘è¦æ—¶é—´ï¼Œå½“é¡¹ç›®è¶Šæ¥è¶Šå¤§æ—¶ï¼Œå°å°æ”¹ä¸ªæ¡£æ¡ˆå¯èƒ½å°±è¦èŠ±æ•°åˆ†é’Ÿå»ç­‰ç¼–è¯‘ã€‚</p>
</blockquote>
<p><img src="./image-20221227221102038.png" alt="image-20221227221102038"></p>
<p>éšç€ C++ çš„å‘å±•ï¼Œç°åœ¨ modern C++ å¦‚ C++14ï¼Œ 17 ç­‰ç­‰ï¼Œæ–°å¢äº†æ›´å¤šæ–¹å¼è®©å¼€å‘è€…åœ¨ç¼–è¯‘æ—¶æœŸå®Œæˆæ›´å¤šäº‹æƒ…ï¼Œæ¯”å¦‚è¯´æ›´æ–¹ä¾¿çš„ç­‰ç­‰åŠŸèƒ½ã€‚ è€Œè¿™å…¶å®ä¹Ÿæ˜¯è¢«é¼“åŠ±çš„ï¼Œå› ä¸ºèƒ½åœ¨ç¼–è¯‘æ—¶æœŸå°±å¤„ç†å®Œçš„è¯å°±å¯ä»¥è®© runtime æ‰§è¡Œå¾—æ›´å¿«ï¼if contexpr
ä½†å½“å¤§é‡ä½¿ç”¨ template æˆ–å¼•ç”¨æ›´å¤šçš„ library ä¹Ÿè®© compiler çš„å·¥ä½œè¶Šæ¥è¶Šå¤šï¼Œè€Œå¦‚æœæ¯æ”¹å‡ è¡Œå°±è¦ç­‰å¾…ç¼–è¯‘å‡ åˆ†é’Ÿæ‰èƒ½çŸ¥é“æ‰§è¡Œç»“æœçš„è¯ï¼Œå¯¹äºä¸€å¤©è¦ç¼–è¯‘æ•°ç™¾æ¬¡çš„å¼€å‘è€…è€Œè¨€å®åœ¨æ˜¯å¤ªæµªè´¹ç”Ÿå‘½äº†ã€‚
æœ¬ç¯‡æ–‡ç« å°±è¦æ¥æ¢è®¨å„ç§åŠ é€Ÿ C++ Compile Time çš„æ–¹å¼ï¼Œå¤§éƒ¨åˆ†çš„æ–¹æ³•éƒ½æ˜¯ Stack Overflow æœåˆ®æ¥ï¼Œç„¶åç”±æˆ‘è‡ªè¡Œå®æµ‹ã€‚ æµ‹è¯•ç¯å¢ƒå¦‚ä¸‹ï¼š</p>
<ul>
<li>Ubuntu 18.04 LTS</li>
<li>GCC 9</li>
<li>CMake 3.23</li>
<li>Ninja 1.8</li>
<li>Project LOC ~20k</li>
</ul>
<h1 id="use-ccache">Use ccache</h1>
<p>å¼•å…¥ ccache ç»å¯¹æ˜¯æ•ˆç›Šæœ€é«˜çš„åŠ é€Ÿæ–¹å¼ï¼Œå®Œå…¨ä¸ç”¨æ”¹ç¨‹åºå°±å¯ä»¥å‡å°‘å¤§é‡çš„ç¼–è¯‘æ—¶é—´ã€‚ ccache æ˜¯ä¸€ä¸ªå…¨å±€çš„ compiler cacheï¼Œè—‰ç”±å¿«å–ç¼–è¯‘çš„ä¸­ç»§æ¡£æ¥èŠ‚çœé‡æ–°ç¼–è¯‘çš„æ—¶é—´ã€‚ å®‰è£…å¥½ä»¥ååªè¦åœ¨ ä¸­åŠ å…¥ï¼šCMakeLists.txt</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span><span style="color:#75715e"># CMakeLists.txt
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>SET_PROPERTY(<span style="color:#e6db74">GLOBAL</span> <span style="color:#e6db74">PROPERTY</span> <span style="color:#e6db74">RULE_LAUNCH_COMPILE</span> <span style="color:#e6db74">ccache</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>å³å¯ä½¿ç”¨ï¼Œå¦‚æœé¡¹ç›®æ²¡ä½¿ç”¨ build tools çš„è¯ï¼Œåˆ™æ˜¯ç›´æ¥åœ¨æŒ‡ä»¤å‰åŠ ä¸Š<code>ccache</code>, <code>gcc  ccache</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># before</span>
</span></span><span style="display:flex;"><span>$ /usr/bin/gcc main.cpp
</span></span><span style="display:flex;"><span><span style="color:#75715e"># after</span>
</span></span><span style="display:flex;"><span>$ ccache /usr/bin/gcc main.cpp
</span></span></code></pre></div><p>ä½¿ç”¨ ccache ä¹‹åæ•´ä½“ç¼–è¯‘é€Ÿåº¦å¤§çº¦å¯ä»¥æå‡ä¸¤å€ä»¥ä¸Šï¼Œååˆ†èµï¼</p>
<h1 id="use-forward-declaration-as-more-as-possible">Use forward declaration as more as possible</h1>
<p>C++ çš„ å…³é”®è¯å…¶å®å°±æ˜¯å¤åˆ¶ç²˜è´´ï¼Œæ‰€ä»¥å½“ä½ åœ¨ A.h include äº† B.hï¼Œåœ¨é¢„å¤„ç†é˜¶æ®µç¼–è¯‘å™¨ä¼šæŠŠ B.h å†…å®¹å¤åˆ¶åˆ° A.hï¼Œè€Œå¦‚æœä¸å¹¸çš„ B.h åˆ include ä¸€å †æ¡£æ¡ˆï¼Œé‚£ä¹Ÿä¼šé€šé€šå±•å¼€ã€‚ æ‰€ä»¥å¦‚æœå¼•ç”¨å¤ªå¤šæ¡£æ¡ˆï¼Œé™¤äº†ä¼šé€ æˆé¢„å¤„ç†ä¹‹åæ¡£æ¡ˆè‚¥å¤§ä»¥å¤–ï¼Œä¹Ÿä¼šé€ æˆæ¡£æ¡ˆä¹‹é—´ç›¸ä¾æ€§æ··ä¹±ï¼Œé—´æ¥å¯¼è‡´æ¯æ¬¡ç¼–è¯‘è¦é‡æ–°ç¼–è¯‘ä¸å¿…è¦çš„æ¡£æ¡ˆã€‚#include</p>
<p>é™¤äº†å°†æ²¡ç”¨çš„ include æ¸…å¹²å‡€ä»¥å¤–ï¼Œè¿˜å¯ä»¥æ›´æ¿€è¿›çš„é¿å…åœ¨ header include ä¸œè¥¿ï¼Œé‚£å°±æ˜¯åˆ©ç”¨ forward declarationã€‚
<img src="./image-20221227221151475.png" alt="image-20221227221151475"></p>
<p>è¯•æƒ³ä»¥ä¸Šæƒ…å¢ƒï¼Œå½“ä½ å˜æ›´ A.h æ—¶ï¼ŒA B C éƒ½å¿…é¡»é‡æ–°ç¼–è¯‘ï¼Œå› ä¸ºå†…å®¹æ”¹å˜äº†ï¼Œä½†å®é™…ä¸Š C å¹¶æœªä½¿ç”¨åˆ° Aï¼Œå…¶å®åº”è¯¥å¯ä»¥é¿å…é‡æ–°ç¼–è¯‘ Cã€‚</p>
<p>ç”±äºCä¼šé‡æ–°ç¼–è¯‘æ˜¯å› ä¸º B.h å†…å®¹æ”¹å˜äº†ï¼Œè€Œ B.h å†…å®¹æ”¹å˜çš„åŸå› åˆ™æ˜¯å› ä¸º A.h æ›´æ–°äº†ã€‚ è¿™æ—¶å€™å¯ä»¥æŸ¥çœ‹ä¸ºç”šä¹ˆ B.h éœ€è¦å¼•ç”¨ A.hï¼Œçœ‹çœ‹æ˜¯å¦å¯ä»¥é¿å…å¼•ç”¨ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/// B.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;A.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>class B {
</span></span><span style="display:flex;"><span> <span style="color:#75715e">// ...skip
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> private:
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> A<span style="color:#f92672">&amp;</span> a;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>ä»¥ä¸Šæ˜¯å¸¸è§çš„ä½¿ç”¨æƒ…å¢ƒï¼ŒB å­˜äº†ä¸€ä¸ª class A çš„å‚è€ƒã€‚<code>A&amp; a</code></p>
<p>æˆ‘ä»¬å¯ä»¥æ”¹å†™æˆè¿™æ ·ï¼Œå°† include ç§»åŠ¨åˆ° B.cpp å®ä½œæ–‡ä»¶ä¸­ã€‚ è¿™æ˜¯å› ä¸ºï¼Œ ç­‰è¿™ç±»ä¸œè¥¿çš„å¤§å°æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥åœ¨å®šä¹‰æ—¶ä¸éœ€è¦çŸ¥é“å®é™… class A çš„å¤§å°ï¼Œåªéœ€å…ˆå‘ŠçŸ¥ compiler æœ‰è¿™ä¸ª class å³å¯ã€‚<code>A&amp; </code> <code>A*</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#75715e">/// B.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">A</span>; <span style="color:#75715e">//&lt; forward declare !
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">B</span> {
</span></span><span style="display:flex;"><span> <span style="color:#75715e">// ...skip
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> <span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> A<span style="color:#f92672">&amp;</span> a;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// B.cpp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;A.h&#34;</span><span style="color:#75715e">
</span></span></span></code></pre></div><p>å¦‚æ­¤ä¸€æ¥ï¼Œå½“ä½ å˜æ›´ A.h æ—¶ï¼ŒB.h å†…å®¹å¹¶ä¸ä¼šæ”¹å˜ï¼Œä¹Ÿå°±ä¸ä¼šè§¦å‘ C éœ€è¦é‡æ–°ç¼–è¯‘æ‹‰ï¼Œå¯å–œå¯è´º~</p>
<p>åœ¨å¤§é‡ä½¿ç”¨è¿™ä¸ªæŠ€å·§ä»¥åï¼Œæˆ‘æ‰€æµ‹è¯•çš„é¡¹ç›®è¿›æ­¥å¹…åº¦ä¹Ÿæ˜¯éå¸¸æ˜æ˜¾ï¼Œæ›´åŠ¨A.håŸæœ¬ä¼šç‰µåŠ¨54ä¸ªæ¡£æ¡ˆéœ€è¦é‡ç¼–è¯‘ï¼Œæ”¹å®Œä»¥ååˆ™åªä¼šç‰µåŠ¨29ä¸ªæ¡£æ¡ˆï¼Œè‡ªç„¶ç¼–è¯‘é€Ÿåº¦ä¹Ÿå°±å˜å¿«äº†ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># before use fwd v.s. after use fwd</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -j 6 incremental build, w/o ccache, unit in second</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>touch A.h<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>before <span style="color:#f92672">=</span> <span style="color:#ae81ff">303</span> <span style="color:#f92672">(</span>trigger <span style="color:#ae81ff">54</span> files rebuild<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>after  <span style="color:#f92672">=</span> <span style="color:#ae81ff">178</span> <span style="color:#f92672">(</span>trigger <span style="color:#ae81ff">29</span> files rebuild<span style="color:#f92672">)</span>
</span></span></code></pre></div><h1 id="unity-build">Unity Build</h1>
<p>Unity build åˆç§° Jumbo buildï¼Œ Mega buildï¼Œå…¶åŸç†æ˜¯é€è¿‡å°†æ±‡æ•´æˆä¸€ä¸ªå†ä¸€èµ·æ‰§è¡Œç¼–è¯‘ï¼Œè¿™æ ·å°±æ˜¯çœä¸‹ N ä¸ªæ¡£æ¡ˆçš„ç¼–è¯‘æ—¶é—´ ï¼ˆå…·ä½“è€Œè¨€æ˜¯çœä¸‹å¦‚ template å±•å¼€ç­‰åŸæœ¬æ¯ä¸ª Translate Unit éƒ½è¦åšçš„äº‹æƒ…ï¼‰ã€‚<code>*.cppall.cpp</code></p>
<p>CMake v3.16 å¼€å§‹å°±æ”¯æŒ Unity Build çš„è®¾å®šï¼Œä»–æ”¯æŒå°† batch size ä¸ªæ–‡ä»¶å…ˆæ±‡æ€»æˆä¹‹åå†è¿›è¡Œç¼–è¯‘ã€‚all_x.cpp</p>
<p>ä¸è¿‡è¿™æ–¹æ³•ä¼šé‡åˆ°ä¸€äº›é—®é¢˜ï¼Œç”±äºè¿™æ–¹æ³•ä¹‹åŸç†è¯´ç™½äº†å°±æ˜¯å¦‚æ­¤æš´åŠ›ï¼Œå¦‚æœé¡¹ç›®æœ¬èº«å¸¸å¸¸ä½¿ç”¨å…¨å±€å˜é‡çš„è¯ï¼Œè¿™ä¼šå¾ˆå®¹æ˜“å¯¼è‡´ODR ï¼ˆOne definition ruleï¼‰ é”™è¯¯ã€‚ æ‰€ä»¥ä¹Ÿæœ‰å¯èƒ½ä¸å®¹æ˜“å¼•å…¥ Unity Buildã€‚<code>cat *.cpp &gt; all.cpp</code></p>
<p>è¿™ä¸ªæŠ€å·§æˆ‘è®¤ä¸ºä¹Ÿæ˜¯ CP å€¼ååˆ†ä¹‹é«˜çš„æ–¹æ³•ï¼Œå‡ ä¹ä¸ç”¨æ”¹ç¨‹åº ï¼ˆå¦‚æœé¡¹ç›®ç”¨å¤ªå¤šå…¨å±€å˜é‡å°±è¦æ”¹å¾ˆå¤šğŸ˜…ï¼‰ å´å¯ä»¥è·å¾—å¤§å¹…çš„è¿›æ­¥ã€‚ æˆ‘æµ‹è¯•çš„ç»“æœå¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°æ— è®ºæ˜¯ incremental build è¿˜æ˜¯ clean build éƒ½å–å¾— 50% ä»¥ä¸Šçš„è¿›æ­¥ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e"># w/o unity build v.s. with unity build (batch_size=8)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># using -j 6, w/o ccache, unit in seconds
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>[touch A.h]
</span></span><span style="display:flex;"><span>before <span style="color:#f92672">=</span> <span style="color:#ae81ff">242</span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#ae81ff">38</span> tasks
</span></span><span style="display:flex;"><span>after  <span style="color:#f92672">=</span> <span style="color:#ae81ff">167</span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#ae81ff">18</span> tasks
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[clean build]
</span></span><span style="display:flex;"><span>before <span style="color:#f92672">=</span> <span style="color:#ae81ff">420</span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#ae81ff">111</span> tasks
</span></span><span style="display:flex;"><span>after  <span style="color:#f92672">=</span> <span style="color:#ae81ff">224</span> <span style="color:#960050;background-color:#1e0010">#</span>  <span style="color:#ae81ff">47</span> tasks
</span></span></code></pre></div><h1 id="better-linker">Better linker</h1>
<p>ç¼–è¯‘çš„æœ€åé˜¶æ®µæ˜¯ linkingï¼Œè¿™éƒ¨åˆ†å¯ä»¥æ›¿æ¢æˆæ¯”è¾ƒå‰å®³çš„ linkerï¼Œå¸‚é¢ä¸Šç›®å‰æœ‰ä¸‰ç§è¾ƒæœ‰åçš„ linker</p>
<ul>
<li>ld (gcc default)</li>
<li>gold</li>
<li>lld</li>
<li></li>
</ul>
<p>è¦æ›¿æ¢ä½¿ç”¨ linker åªéœ€è¦åœ¨ compile flag åŠ ä¸Šå³å¯ã€‚ è¯¦ç»†å¯å‚è€ƒ gcc documentã€‚ è€Œæˆ‘å®æµ‹ä¸åŒ linker è¡¨ç°å¦‚ä¸‹ï¼Œfuse-ld=&lt;linker_name&gt;</p>
<pre tabindex="0"><code class="language-ba" data-lang="ba"># rebuild using single thread, unit in second
# [1/1] Linking CXX executable main
[linker]
ld   = 25.4
gold = 11.6
lld  =  5.8
</code></pre><p>ä½¿ç”¨æ›´å¼ºçš„ linker è™½ç„¶ä½¿ linking time è¿›æ­¥è®¸å¤šï¼Œä½†å¯¹æ•´ä¸ªé¡¹ç›®çš„ compile time è€Œè¨€å…¶å®å æ¯”ä¸æ˜¯å¾ˆå¤§ï¼Œç›¸è¾ƒäºå‰é¢å‡ ä¸ªç« èŠ‚ç®—æ˜¯è¿›æ­¥è¾ƒå°çš„æŠ€å·§ã€‚ ï¼ˆä½† CP å€¼ä¹Ÿæ˜¯å¾ˆé«˜ï¼Œåªè¦æ”¹ä¸€ä¸ª compile flagï¼‰</p>
<h1 id="disable-var-tracking-for-huge-variable-object">Disable var-tracking for huge variable object</h1>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ gcc flag æ¥å‰–æç¼–è¯‘å„ä¸ªé˜¶æ®µçš„è€—æ—¶ï¼Œç„¶åé’ˆå¯¹å„ä¸ªè€—æ—¶å¤§çš„æ”¹å–„ã€‚<code>-ftime-report</code></p>
<p>æˆ‘æµ‹è¯•çš„é¡¹ç›®ä¸­ï¼Œæœ‰ä¸€ä¸ª auto-generate çš„ï¼Œè¯¥æ¡£æ¡ˆåŠ¨è¾„æ•°ä¸‡è¡Œï¼Œæ¯æ¬¡ç¼–è¯‘è¯¥æ¡£æ¡ˆéƒ½ä¼šæˆä¸ºç“¶é¢ˆã€‚ ä»å¾—çŸ¥ç¼–è¯‘è¯¥æ¡£æ¡ˆè€—æ—¶æœ€å¤§çš„éƒ¨åˆ†æ˜¯ var-trackingï¼Œvar-tracking æ˜¯è®© debug info æœ‰æ›´å¤šä¿¡æ¯çš„åŠŸèƒ½ï¼Œä½†å½“é¡¹ç›®ä¸­æœ‰å·¨å¤§çš„å˜é‡æ—¶ï¼Œè¿™ä¼šè®© compiling é€Ÿåº¦å¤§å¹…å˜æ…¢ã€‚<code>unordered_map-ftime-report</code></p>
<p>åœ¨å¯¹æˆ‘é‚£ä¸ªæ•°ä¸‡è¡Œçš„æ¡£æ¡ˆæ‹¿æ‰ var-tracking ä¹‹å ï¼ˆé’ˆå¯¹è¯¥æ–‡ä»¶åŠ ä¸Šä¸€ä¸ªflagï¼‰ ç»“æœå¦‚ä¸‹ï¼Œ<code>unordered_map</code> <code>-ftime-report</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># gcc -ftime-report auto_gen.cpp</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># with var-tracking v.s. without var-tracking, sorted by usr time</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>before<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Time variable                                   usr           sys          wall               GGC
</span></span><span style="display:flex;"><span> phase opt and generate             : 122.95 <span style="color:#f92672">(</span> 92%<span style="color:#f92672">)</span>   2.30 <span style="color:#f92672">(</span> 35%<span style="color:#f92672">)</span> 125.26 <span style="color:#f92672">(</span> 89%<span style="color:#f92672">)</span>  <span style="color:#ae81ff">924305</span> kB <span style="color:#f92672">(</span> 46%<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> var-tracking dataflow              :  71.39 <span style="color:#f92672">(</span> 53%<span style="color:#f92672">)</span>   0.15 <span style="color:#f92672">(</span>  2%<span style="color:#f92672">)</span>  71.57 <span style="color:#f92672">(</span> 51%<span style="color:#f92672">)</span>    <span style="color:#ae81ff">3714</span> kB <span style="color:#f92672">(</span>  0%<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> expand vars                        :  17.55 <span style="color:#f92672">(</span> 13%<span style="color:#f92672">)</span>   0.03 <span style="color:#f92672">(</span>  0%<span style="color:#f92672">)</span>  17.56 <span style="color:#f92672">(</span> 12%<span style="color:#f92672">)</span>    <span style="color:#ae81ff">8583</span> kB <span style="color:#f92672">(</span>  0%<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> phase parsing                      :   8.09 <span style="color:#f92672">(</span>  6%<span style="color:#f92672">)</span>   3.46 <span style="color:#f92672">(</span> 53%<span style="color:#f92672">)</span>  11.55 <span style="color:#f92672">(</span>  8%<span style="color:#f92672">)</span>  <span style="color:#ae81ff">794986</span> kB <span style="color:#f92672">(</span> 40%<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> alias stmt walking                 :   6.11 <span style="color:#f92672">(</span>  5%<span style="color:#f92672">)</span>   0.08 <span style="color:#f92672">(</span>  1%<span style="color:#f92672">)</span>   6.40 <span style="color:#f92672">(</span>  5%<span style="color:#f92672">)</span>     <span style="color:#ae81ff">678</span> kB <span style="color:#f92672">(</span>  0%<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> template instantiation             :   4.35 <span style="color:#f92672">(</span>  3%<span style="color:#f92672">)</span>   1.58 <span style="color:#f92672">(</span> 24%<span style="color:#f92672">)</span>   6.03 <span style="color:#f92672">(</span>  4%<span style="color:#f92672">)</span>  <span style="color:#ae81ff">443040</span> kB <span style="color:#f92672">(</span> 22%<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> phase lang. deferred               :   2.30 <span style="color:#f92672">(</span>  2%<span style="color:#f92672">)</span>   0.72 <span style="color:#f92672">(</span> 11%<span style="color:#f92672">)</span>   3.02 <span style="color:#f92672">(</span>  2%<span style="color:#f92672">)</span>  <span style="color:#ae81ff">232700</span> kB <span style="color:#f92672">(</span> 12%<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> var-tracking emit                  :   2.87 <span style="color:#f92672">(</span>  2%<span style="color:#f92672">)</span>   0.02 <span style="color:#f92672">(</span>  0%<span style="color:#f92672">)</span>   2.95 <span style="color:#f92672">(</span>  2%<span style="color:#f92672">)</span>   <span style="color:#ae81ff">20420</span> kB <span style="color:#f92672">(</span>  1%<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> |overload resolution               :   3.18 <span style="color:#f92672">(</span>  2%<span style="color:#f92672">)</span>   1.26 <span style="color:#f92672">(</span> 19%<span style="color:#f92672">)</span>   4.50 <span style="color:#f92672">(</span>  3%<span style="color:#f92672">)</span>  <span style="color:#ae81ff">330116</span> kB <span style="color:#f92672">(</span> 16%<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> TOTAL                              : 134.16          6.54        140.82        <span style="color:#ae81ff">2005866</span> kB
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>after<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Time variable                                   usr           sys          wall               GGC
</span></span><span style="display:flex;"><span> phase opt and generate             :  44.61 <span style="color:#f92672">(</span> 80%<span style="color:#f92672">)</span>   1.41 <span style="color:#f92672">(</span> 27%<span style="color:#f92672">)</span>  46.03 <span style="color:#f92672">(</span> 76%<span style="color:#f92672">)</span>  <span style="color:#ae81ff">724840</span> kB <span style="color:#f92672">(</span> 41%<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> expand vars                        :  18.45 <span style="color:#f92672">(</span> 33%<span style="color:#f92672">)</span>   0.02 <span style="color:#f92672">(</span>  0%<span style="color:#f92672">)</span>  18.46 <span style="color:#f92672">(</span> 30%<span style="color:#f92672">)</span>    <span style="color:#ae81ff">8567</span> kB <span style="color:#f92672">(</span>  0%<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> phase parsing                      :   8.32 <span style="color:#f92672">(</span> 15%<span style="color:#f92672">)</span>   3.12 <span style="color:#f92672">(</span> 59%<span style="color:#f92672">)</span>  11.45 <span style="color:#f92672">(</span> 19%<span style="color:#f92672">)</span>  <span style="color:#ae81ff">794986</span> kB <span style="color:#f92672">(</span> 45%<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> alias stmt walking                 :   6.39 <span style="color:#f92672">(</span> 12%<span style="color:#f92672">)</span>   0.11 <span style="color:#f92672">(</span>  2%<span style="color:#f92672">)</span>   6.52 <span style="color:#f92672">(</span> 11%<span style="color:#f92672">)</span>     <span style="color:#ae81ff">678</span> kB <span style="color:#f92672">(</span>  0%<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> template instantiation             :   4.38 <span style="color:#f92672">(</span>  8%<span style="color:#f92672">)</span>   1.44 <span style="color:#f92672">(</span> 27%<span style="color:#f92672">)</span>   5.93 <span style="color:#f92672">(</span> 10%<span style="color:#f92672">)</span>  <span style="color:#ae81ff">443040</span> kB <span style="color:#f92672">(</span> 25%<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> |overload resolution               :   3.27 <span style="color:#f92672">(</span>  6%<span style="color:#f92672">)</span>   0.97 <span style="color:#f92672">(</span> 18%<span style="color:#f92672">)</span>   4.51 <span style="color:#f92672">(</span>  7%<span style="color:#f92672">)</span>  <span style="color:#ae81ff">330116</span> kB <span style="color:#f92672">(</span> 19%<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> phase lang. deferred               :   2.27 <span style="color:#f92672">(</span>  4%<span style="color:#f92672">)</span>   0.70 <span style="color:#f92672">(</span> 13%<span style="color:#f92672">)</span>   2.97 <span style="color:#f92672">(</span>  5%<span style="color:#f92672">)</span>  <span style="color:#ae81ff">232700</span> kB <span style="color:#f92672">(</span> 13%<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> parser <span style="color:#f92672">(</span>global<span style="color:#f92672">)</span>                    :   1.89 <span style="color:#f92672">(</span>  3%<span style="color:#f92672">)</span>   0.90 <span style="color:#f92672">(</span> 17%<span style="color:#f92672">)</span>   3.05 <span style="color:#f92672">(</span>  5%<span style="color:#f92672">)</span>  <span style="color:#ae81ff">211250</span> kB <span style="color:#f92672">(</span> 12%<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> tree SSA incremental               :   1.58 <span style="color:#f92672">(</span>  3%<span style="color:#f92672">)</span>   0.01 <span style="color:#f92672">(</span>  0%<span style="color:#f92672">)</span>   1.55 <span style="color:#f92672">(</span>  3%<span style="color:#f92672">)</span>     <span style="color:#ae81ff">259</span> kB <span style="color:#f92672">(</span>  0%<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> TOTAL                              :  55.49          5.27         60.81        <span style="color:#ae81ff">1761326</span> kB
</span></span></code></pre></div><p>ç»“æœæ˜¯ä»åŸæœ¬è€—æ—¶134ç§’é™ä½è‡³è€—æ—¶55ç§’ï¼Œå‡å°‘è¶…è¿‡50%çš„æ—¶é—´ã€‚ è¿™ä¹Ÿä½¿å¾—è¯¥æ¡£æ¡ˆä¸ä¼šå†æ˜¯æ•´ä¸ªé¡¹ç›®çš„ç“¶é¢ˆã€‚</p>
<h1 id="summary">Summary</h1>
<p>æœ¬æ–‡å°è¯•äº†è®¸å¤šæŠ€å·§æ¥åŠ é€Ÿç¼–è¯‘æ‰€éœ€çš„æ—¶é—´ï¼Œæ€»ç»“å„ç‚¹å¦‚ä¸‹åˆ—ï¼š</p>
<ul>
<li>Use [big improvement] <code>ccache</code></li>
<li>Use forward declaration as more as possible [big improvement]</li>
<li>Unity Build [big improvement]</li>
<li>Use LLVM linker [good improvement]</li>
<li>Disable var-tracking for huge variable object [good improvement]</li>
<li>Pre-compiled headers [no improvement]</li>
<li>Explicit template instantiation [no improvement]
åœ¨çˆ¬æ–‡æ—¶ç½‘å‹æåŠ pre-compiled headers ä»¥åŠ explicit ï¼ˆexternï¼‰ template ä¹Ÿå¯¹å‡å°‘ç¼–è¯‘æ—¶é—´æœ‰å¸®åŠ©ï¼Œä½†å®æµ‹å¹¶æœªæœ‰æ˜¾è‘—å·®å¼‚ï¼Œæ•…æœ¬æ–‡æœªæåŠï¼Œä¹Ÿè®¸å®é™…ä¸Šæ˜¯æœ‰ç”¨åªæ˜¯åˆšå¥½ä¸é€‚ç”¨äºæˆ‘çš„ç¯å¢ƒä¹‹ç±»çš„ã€‚</li>
</ul>
<h1 id="reference">Reference</h1>
<ul>
<li>Improving Compilation Time of C/C++ Projects</li>
<li>â€œvariable trackingâ€ is eating my compile time!</li>
<li>CMake Unity Build</li>
</ul>
<blockquote>
<p>åŸæ–‡é“¾æ¥: <a href="https://ssarcandy.tw/2022/06/11/optimizing-compile-time/">https://ssarcandy.tw/2022/06/11/optimizing-compile-time/</a></p>
</blockquote>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/c&#43;&#43;/" rel="tag">C&#43;&#43;</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>

<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="Corsair-cxs avatar" src="/img/gedu.jpg" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">å…³äº Corsair-cxs</span>
	</div>
	<div class="authorbox__description">
		ç®€ä»‹
	</div>
</div>

<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/post/dev/c&#43;&#43;/8.toolkit/3.compiler/compiler_optimization_techniques/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;ä¸Šä¸€ç¯‡</span>
			<p class="pager__title">è°ˆè°ˆç¼–è¯‘æœŸä¼˜åŒ–</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/post/misc/oh-my-posh/" rel="next">
			<span class="pager__subtitle">ä¸‹ä¸€ç¯‡&thinsp;Â»</span>
			<p class="pager__title">Windowså®‰è£…posh</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2025 ç‰ˆæƒå½’ä½œè€…æ‰€æœ‰,å¦‚éœ€è½¬è½½è¯·è¯´æ˜å‡ºå¤„.
			<span class="footer__copyright-credits">åŸºäº <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> å¼•æ“å’Œ <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> ä¸»é¢˜</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
<script src="/js/custom.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>
</body>
</html>